!function(){"use strict";var t=Laya.View,e=(Laya.Dialog,Laya.Scene),s=Laya.ClassUtils.regClass;class i extends t{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("test/GameView")}}s("ui.test.GameViewUI",i);class a extends e{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("test/TestScene")}}s("ui.test.TestSceneUI",a);class n extends t{constructor(){super()}createChildren(){super.createChildren(),this.loadScene("test/WinView")}}s("ui.test.WinViewUI",n);class r{constructor(){}WorldToScreen2(t,e){var s=this.InverseTransformPoint(t.transform,e).z,i=new Laya.Vector3;return t.viewport.project(e,t.projectionViewMatrix,i),new Laya.Vector3(i.x/Laya.stage.clientScaleX,i.y/Laya.stage.clientScaleY,s)}ScreenToWorld(t,e){var s=.5*t.fieldOfView*Math.PI/180;let i=e.z*Math.tan(s),a=i*t.aspectRatio,n=this.GetLowerLeft(t.transform,e.z,a,i),r=this.GetScreenScale(a,i);var h=new Laya.Vector3,o=this.InverseTransformPoint(t.transform,n);return h=new Laya.Vector3(-e.x/r.x,e.y/r.y,0),Laya.Vector3.add(o,h,h),h=this.TransformPoint(t.transform,h)}GetScreenScale(t,e){var s=new Laya.Vector3;return s.x=Laya.stage.width/t/2,s.y=Laya.stage.height/e/2,s}GetLowerLeft(t,e,s,i){var a=new Laya.Vector3,n=new Laya.Vector3;t.getRight(n),Laya.Vector3.normalize(n,n);var r=new Laya.Vector3(n.x*s,n.y*s,n.z*s);Laya.Vector3.add(t.position,r,a);var h=new Laya.Vector3;t.getUp(h),Laya.Vector3.normalize(h,h);var o=new Laya.Vector3(h.x*i,h.y*i,h.z*i);Laya.Vector3.subtract(a,o,a);var l=new Laya.Vector3;t.getForward(l),Laya.Vector3.normalize(l,l);var c=new Laya.Vector3(l.x*e,l.y*e,l.z*e);return Laya.Vector3.subtract(a,c,a),a}InverseTransformPoint(t,e){var s=new Laya.Vector3;t.getRight(s);var i=new Laya.Vector3;t.getUp(i);var a=new Laya.Vector3;t.getForward(a);var n=new Laya.Vector3(-a.x,-a.y,-a.z),r=this.ProjectDistance(e,t.position,s),h=this.ProjectDistance(e,t.position,i),o=this.ProjectDistance(e,t.position,n);return new Laya.Vector3(r,h,o)}TransformPoint(t,e){var s=new Laya.Vector3;return Laya.Vector3.transformQuat(e,t.rotation,s),Laya.Vector3.add(s,t.position,s),s}ProjectDistance(t,e,s){var i=new Laya.Vector3;Laya.Vector3.subtract(t,e,i);var a=this.Angle2(i,s)*Math.PI/180,n=Laya.Vector3.distance(t,e);return n*=Math.cos(a)}Angle2(t,e){var s=(t.x*e.x+t.y*e.y+t.z*e.z)/(Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z)*Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z));return s<-1&&(s=-1),s>1&&(s=1),180*Math.acos(s)/Math.PI}}class h extends i{constructor(t){super(),this.that=t}onEnable(){this.nextBtn.on(Laya.Event.CLICK,this,this.onNextGame),this.resetBtn.on(Laya.Event.CLICK,this,this.onResetGame),this.init()}init(){this.btnList=[this.btn1,this.btn2,this.btn3,this.btn4,this.btn5],this.btnList.forEach(t=>{t.alpha=0}),this.btn1.on(Laya.Event.MOUSE_DOWN,this,()=>{this.that.logic(0)}),this.btn2.on(Laya.Event.MOUSE_DOWN,this,()=>{this.that.logic(1)}),this.btn3.on(Laya.Event.MOUSE_DOWN,this,()=>{this.that.logic(2)}),this.btn4.on(Laya.Event.MOUSE_DOWN,this,()=>{this.that.logic(3)}),this.btn5.on(Laya.Event.MOUSE_DOWN,this,()=>{this.that.logic(4)})}onNextGame(t=null){this.result.visible=!1,this.game.visible=!0}onResult(){this.that.nextGame(),this.result.visible=!0,this.game.visible=!1}onResetGame(){this.that.initCurrentStage()}updateView(t,e){let s=new r;for(let i=1;i<6;i++){let a=s.WorldToScreen2(t,e[i-1].transform.position);this["btn"+i]&&(this["btn"+i].x=a.x-this["btn"+i].width/2),this["btn"+i].y=a.y-100,this["btn"+i].height=400}}}class o{constructor(t,e,s,i){this.startPoint=t,this.endPoint=e,this.parent=s,this.world=i,this.listSP=[],this.listBox=[],this.constraintList=[],this.ballNum=14,this.size=6,this.dist=8,this.sphereShape,this.mass=2,this.lastBody=null,this.offsetDist=0}drawLine(t){this.sphereShape=new CANNON.Sphere(this.size);for(let i=0;i<this.ballNum;i++){var e=new CANNON.Body({mass:0===i||i===this.ballNum-1?0:this.mass});e.addShape(this.sphereShape),e.position.set(this.startPoint.x,(this.ballNum-i)*(this.dist-this.offsetDist)-this.ballNum*(this.dist-this.offsetDist)/2,this.startPoint.z),this.world.addBody(e),this.listSP.push(e);var s=new Laya.MeshSprite3D(Laya.PrimitiveMesh.createSphere(this.size));if(this.parent.addChild(s),s.transform.rotate(new Laya.Vector3(0,30,0),!1,!1),s.transform.position=new Laya.Vector3(this.startPoint.x,(this.ballNum-i)*(this.dist-this.offsetDist)-this.ballNum*(this.dist-this.offsetDist)/2,this.startPoint.z),s.meshRenderer.material=t,this.listBox.push(s),null!==this.lastBody){let t=new CANNON.DistanceConstraint(e,this.lastBody,this.dist-this.offsetDist);t.collideConnected=!0,this.world.addConstraint(t),this.constraintList.push(t)}this.lastBody=e}this.updatePhy()}despose(){let t=this;this.constraintList.forEach(e=>{e&&(t.world.removeConstraint(e),e=null)}),this.constraintList=[];for(let t=0;t<this.listSP.length;t++)this.world.removeBody(this.listSP[t]),this.listBox[t].destroy(),this.listBox[t].destroy();this.listSP=[],this.listBox=[]}updatePhy(){let t=this;for(let e=0;e<t.listBox.length;e++){let s=t.listSP[e].position;t.listBox[e].transform.position=new Laya.Vector3(s.x,s.y,s.z)}}endLine(){return this.listSP.length<=0?null:this.listSP[this.listSP.length-1]}minX(){if(this.listSP.length<=0)return 0;let t=this.listSP[0].position.x;return this.listSP.forEach(e=>{e&&e.position.x<t&&(t=e.position.x)}),t}maxX(){if(this.listSP.length<=0)return 0;let t=this.listSP[0].position.x;return this.listSP.forEach(e=>{e&&e.position.x>t&&(t=e.position.x)}),t}}class l extends a{constructor(){super(),this.lines=null,this.lines2=null,this.lines3=null,this.textureList=[],this.btnList=[],this.gamestate=-1,this.lineMatList=[],this.pos=[-30,-15,0,15,30],this.listPos=[0,1,2,3,0],this.endBallIndex=null,this.lineIndex=-1,this.lineBackIndex=-1,this.up=!1,this.lineList=[]}onOpened(){this.gameUI=new h(this),this.contant.addChild(this.gameUI),Laya.loader.create(["res/mat/hong.png","res/mat/huang.png","res/mat/lan.png","res/mat/lv.png","res/mat/zi.png","res/mat/gan.png"],Laya.Handler.create(this,this.onPreLoadFinish))}onLoaded(){}onPreLoadFinish(){let t=Laya.Loader.getRes("res/mat/hong.png"),e=Laya.Loader.getRes("res/mat/huang.png"),s=Laya.Loader.getRes("res/mat/lan.png"),i=Laya.Loader.getRes("res/mat/lv.png"),a=Laya.Loader.getRes("res/mat/zi.png"),n=Laya.Loader.getRes("res/mat/gan.png");this.textureList.push(n),this.textureList.push(t),this.textureList.push(e),this.textureList.push(s),this.textureList.push(i),this.textureList.push(a);for(let t=0;t<5;t++){var r=new Laya.BlinnPhongMaterial;r.albedoTexture=this.textureList[t+1],this.lineMatList.push(r)}this.scene2=new Laya.Scene3D,Laya.stage.addChild(this.scene2),this.initScene(),this.stage.setChildIndex(this.scene2,0)}initScene(){this.camera=this.scene2.addChild(new Laya.Camera(0,.1,300)),this.camera.transform.translate(new Laya.Vector3(0,-30,200)),this.camera.transform.rotate(new Laya.Vector3(10,0,0),!0,!1);var t=this.scene2.addChild(new Laya.DirectionLight);t.color=new Laya.Vector3(.6,.6,.6),t.transform.worldMatrix.setForward(new Laya.Vector3(0,0,-1)),this.world=new CANNON.World,this.world.broadphase=new CANNON.NaiveBroadphase,this.world.gravity.set(0,0,-10),this.world.solver.tolerance=.001,this.initGan(),this.initLine(),this.initBtnBall(),this.initCurrentStage(),Laya.timer.loop(1e3,this,this.updateView);var e;let s=this;!function simloop(t){if(requestAnimationFrame(simloop),void 0!==e){var i=(t-e)/1e3;s.world.step(1/60,i,3)}s.lineList.forEach(t=>{t&&t.updatePhy()}),e=t}()}initGan(){var t=new Laya.MeshSprite3D(Laya.PrimitiveMesh.createCylinder(5,90));this.scene2.addChild(t),t.transform.rotate(new Laya.Vector3(0,0,90),!1,!1);t.transform.position=new Laya.Vector3(0,64,30);var e=new Laya.BlinnPhongMaterial;e.albedoTexture=this.textureList[5],t.meshRenderer.material=e}initLine(){this.listPos=[0,1,2,3,0],this.lines=new o({x:this.pos[1],y:-60,z:30},null,this.scene2,this.world),this.lines.drawLine(this.lineMatList[0]),this.lineList.push(this.lines),this.lines2=new o({x:this.pos[2],y:-60,z:30},null,this.scene2,this.world),this.lines2.drawLine(this.lineMatList[1]),this.lineList.push(this.lines2),this.lines3=new o({x:this.pos[3],y:-60,z:30},null,this.scene2,this.world),this.lines3.drawLine(this.lineMatList[2]),this.lineList.push(this.lines3)}initBtnBall(){for(let e=0;e<5;e++){let s=new Laya.MeshSprite3D(Laya.PrimitiveMesh.createSphere(7));this.scene2.addChild(s),s.transform.position=new Laya.Vector3(this.pos[e],-53,30);var t=new Laya.BlinnPhongMaterial;t.albedoTexture=this.textureList[5],s.meshRenderer.material=t,this.btnList.push(s)}this.updateBtnMat()}initCurrentStage(){this.listPos=[0,1,2,3,0],this.endBallIndex=null,this.lineIndex=-1,this.lineBackIndex=-1,this.up=!1,setTimeout(()=>{this.resetGame()},100)}clearList(){this.lineList.forEach(t=>{t&&t.despose(),t=null}),this.lineList=[]}resetGame(){this.nextGame()}nextGame(){this.clearList(),this.initLine(),this.logic(2),setTimeout(()=>{this.logic(0),this.gamestate=0},100)}updateView(){this.gameUI.updateView(this.camera,this.btnList),this.checkIsOpen()}updateBtnMat(){for(let t=0;t<this.btnList.length;t++){this.btnList[t]&&this.listPos[t]}}logic(t=0){if(!(this.lineList.length<=0)){if(0==this.up){let e=this.listPos[t];0!=e&&(this.lineBackIndex=t,this.endBallIndex=this.lineList[e-1].endLine(),this.lineIndex=e,this.endBallIndex.position.set(this.pos[t],this.endBallIndex.position.y,40),this.up=!0)}else{0!=this.listPos[t]&&t!=this.lineBackIndex||null!=this.endBallIndex&&(this.endBallIndex.position.set(this.pos[t],this.endBallIndex.position.y,30),this.listPos[this.lineBackIndex]=0,this.listPos[t]=this.lineIndex,this.endBallIndex=null,this.up=!1,this.lineIndex=-1,this.lineBackIndex=-1)}this.updateBtnMat()}}checkIsOpen(){let t=this.checkIsPZ(this.lineList[0],this.lineList[1]),e=this.checkIsPZ(this.lineList[1],this.lineList[2]),s=this.checkIsPZ(this.lineList[0],this.lineList[2]);t||e||s||0==this.gamestate&&(this.gamestate=1,this.gameUI.onResult())}checkIsPZ(t,e){if(null==t||null==e)return!0;for(let t=0;t<e.listSP.length;t++){let s=e.listSP[t].position,i=e.listSP[t].position;if(s.x<i.x)return!0}if(e.minX()<t.maxX())return!0;for(let t=0;t<e.listSP.length;t++){let s=e.listSP[t].position;if(e.listSP[t].position.x>s.x)return!0}}}class c extends n{constructor(){super()}}class d{static init(){let t=Laya.ClassUtils.regClass;t("script/GameView.js",h),t("script/TestSceneView.js",l),t("script/WinView.js",c)}}d.width=750,d.height=1334,d.scaleMode="fixedwidth",d.screenMode="vertical",d.alignV="middle",d.alignH="center",d.startScene="test/TestScene.scene",d.sceneRoot="",d.debug=!1,d.stat=!1,d.physicsDebug=!0,d.exportSceneToJson=!0,d.init();new class{constructor(){window.Laya3D?Laya3D.init(d.width,d.height):Laya.init(d.width,d.height,Laya.WebGL),Laya.Physics&&Laya.Physics.enable(),Laya.DebugPanel&&Laya.DebugPanel.enable(),Laya.stage.scaleMode=d.scaleMode,Laya.stage.screenMode=d.screenMode,Laya.stage.alignV=d.alignV,Laya.stage.alignH=d.alignH,Laya.URL.exportSceneToJson=d.exportSceneToJson,(d.debug||"true"==Laya.Utils.getQueryString("debug"))&&Laya.enableDebugPanel(),d.physicsDebug&&Laya.PhysicsDebugDraw&&Laya.PhysicsDebugDraw.enable(),d.stat&&Laya.Stat.show(),Laya.alertGlobalError(!0),Laya.ResourceVersion.enable("version.json",Laya.Handler.create(this,this.onVersionLoaded),Laya.ResourceVersion.FILENAME_VERSION)}onVersionLoaded(){Laya.AtlasInfoManager.enable("fileconfig.json",Laya.Handler.create(this,this.onConfigLoaded))}onConfigLoaded(){d.startScene&&Laya.Scene.open(d.startScene)}}}();